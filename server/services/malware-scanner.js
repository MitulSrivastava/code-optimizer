const fs = require('fs');
const path = require('path');

// Suspicious patterns to detect
const SUSPICIOUS_PATTERNS = [
  /eval\s*\(/gi,
  /exec\s*\(/gi,
  /Function\s*\(/gi,
  /document\.write\s*\(/gi,
  /innerHTML\s*=/gi,
  /<script[^>]*src\s*=\s*["']https?:\/\/[^"']*["']/gi,
  /atob\s*\(/gi, // Base64 decode
  /fromCharCode/gi,
  /XMLHttpRequest/gi,
  /\.appendChild\s*\(/gi,
  /crypto/gi,
  /mine|miner|coinhive/gi, // Crypto mining
];

// Obfuscation indicators
const OBFUSCATION_PATTERNS = [
  /\\x[0-9a-f]{2}/gi, // Hex encoding
  /\\u[0-9a-f]{4}/gi, // Unicode encoding
  /[a-zA-Z_$][a-zA-Z0-9_$]{50,}/g, // Very long variable names
];

// Suspicious file extensions
const SUSPICIOUS_EXTENSIONS = [
  '.exe', '.dll', '.bat', '.cmd', '.vbs', 
  '.ps1', '.sh', '.app', '.deb', '.rpm'
];

/**
 * Scan a directory for malware/suspicious code
 * @param {string} dirPath - Directory to scan
 * @returns {Object} - Scan results
 */
async function scanDirectory(dirPath) {
  const results = {
    scanned: 0,
    threatsFound: 0,
    suspiciousFiles: [],
    obfuscatedFiles: [],
    blockedFiles: [],
    riskLevel: 'low', // low, medium, high
    scanTimestamp: new Date().toISOString()
  };

  await scanDirectoryRecursive(dirPath, results);
  
  // Determine overall risk level
  if (results.blockedFiles.length > 0) {
    results.riskLevel = 'high';
  } else if (results.threatsFound > 5 || results.obfuscatedFiles.length > 0) {
    results.riskLevel = 'medium';
  }

  return results;
}

/**
 * Recursively scan directory
 */
async function scanDirectoryRecursive(dirPath, results) {
  const files = fs.readdirSync(dirPath);

  for (const file of files) {
    const filePath = path.join(dirPath, file);
    
    if (!fs.existsSync(filePath)) continue;
    
    const stats = fs.statSync(filePath);
    
    if (stats.isDirectory()) {
      await scanDirectoryRecursive(filePath, results);
    } else {
      results.scanned++;
      await scanFile(filePath, file, results);
    }
  }
}

/**
 * Scan individual file
 */
async function scanFile(filePath, fileName, results) {
  const ext = path.extname(fileName).toLowerCase();
  
  // Block dangerous file types
  if (SUSPICIOUS_EXTENSIONS.includes(ext)) {
    results.blockedFiles.push({
      file: fileName,
      reason: 'Potentially dangerous file type',
      threat: 'high'
    });
    results.threatsFound++;
    return;
  }

  // Scan text-based files for suspicious patterns
  if (['.js', '.html', '.htm', '.php', '.css'].includes(ext)) {
    try {
      const content = fs.readFileSync(filePath, 'utf8');
      
      // Check for suspicious patterns
      const suspiciousMatches = [];
      for (const pattern of SUSPICIOUS_PATTERNS) {
        const matches = content.match(pattern);
        if (matches && matches.length > 0) {
          suspiciousMatches.push({
            pattern: pattern.source,
            count: matches.length
          });
        }
      }
      
      if (suspiciousMatches.length > 0) {
        results.suspiciousFiles.push({
          file: fileName,
          patterns: suspiciousMatches,
          threat: suspiciousMatches.length > 3 ? 'medium' : 'low'
        });
        results.threatsFound++;
      }
      
      // Check for obfuscation
      const obfuscationMatches = [];
      for (const pattern of OBFUSCATION_PATTERNS) {
        const matches = content.match(pattern);
        if (matches && matches.length > 10) { // Threshold for obfuscation
          obfuscationMatches.push({
            pattern: pattern.source,
            count: matches.length
          });
        }
      }
      
      if (obfuscationMatches.length > 0) {
        results.obfuscatedFiles.push({
          file: fileName,
          indicators: obfuscationMatches
        });
      }
      
    } catch (error) {
      // Ignore read errors
      console.error(`Error scanning ${fileName}:`, error.message);
    }
  }
}

/**
 * Get human-readable scan summary
 */
function getScanSummary(scanResults) {
  const messages = [];
  
  if (scanResults.riskLevel === 'low' && scanResults.threatsFound === 0) {
    messages.push('‚úÖ No threats detected. Your files appear safe.');
  }
  
  if (scanResults.blockedFiles.length > 0) {
    messages.push(`‚õî ${scanResults.blockedFiles.length} dangerous file(s) blocked`);
  }
  
  if (scanResults.suspiciousFiles.length > 0) {
    messages.push(`‚ö†Ô∏è  ${scanResults.suspiciousFiles.length} file(s) contain suspicious code patterns`);
  }
  
  if (scanResults.obfuscatedFiles.length > 0) {
    messages.push(`üîç ${scanResults.obfuscatedFiles.length} file(s) appear to be obfuscated`);
  }
  
  return messages;
}

module.exports = {
  scanDirectory,
  getScanSummary
};
